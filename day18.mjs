// eslint-disable-next-line no-unused-vars
const input = `[[[2,[3,5]],[8,7]],[[9,3],2]]
[[3,[3,7]],[[3,6],[[1,1],7]]]
[8,[[5,5],[2,9]]]
[[5,[3,5]],[[2,1],[[7,1],[7,7]]]]
[[[[3,3],0],[[0,3],0]],[[8,[2,2]],[[0,4],3]]]
[3,6]
[[5,[[4,2],1]],[[6,[0,3]],[4,[7,7]]]]
[[6,5],[2,[3,6]]]
[[[[0,1],0],[[7,4],5]],[[6,2],[4,[0,8]]]]
[[[[4,7],3],8],[[7,[0,4]],[7,[1,4]]]]
[[[0,[9,8]],[2,9]],[[[6,4],[4,0]],4]]
[2,[[4,[8,5]],[6,8]]]
[[[0,7],[5,[3,0]]],[[[6,4],[3,2]],[[4,7],[9,6]]]]
[[[[0,6],[0,7]],[8,0]],[8,[4,8]]]
[[[[9,9],2],[[6,2],[2,2]]],[[5,[8,8]],6]]
[[0,[[4,6],7]],[[7,[4,8]],9]]
[[0,5],[[5,3],[[3,9],4]]]
[2,[[[9,4],[8,8]],1]]
[5,[[[2,3],6],[2,[7,0]]]]
[[7,[[8,6],3]],[2,[2,7]]]
[6,[[2,4],[[9,7],[5,9]]]]
[[[9,[2,1]],9],1]
[[[6,9],[2,[2,5]]],[[[4,4],0],7]]
[1,[[[3,9],[6,1]],[4,0]]]
[[[3,8],[3,[2,7]]],[[[9,2],2],6]]
[6,[[8,[3,1]],7]]
[[[9,9],7],[[[3,1],[8,4]],[0,0]]]
[[[1,[7,8]],[4,2]],2]
[[9,7],6]
[[6,[4,8]],[[[8,6],[0,1]],[[0,4],[8,4]]]]
[[[[1,8],[8,6]],[9,[2,0]]],[5,[2,[7,2]]]]
[1,9]
[[8,[9,[9,3]]],[[[1,1],8],[[1,5],[8,6]]]]
[[[3,[4,4]],3],[[7,0],[6,0]]]
[[[6,[6,3]],[6,7]],[1,[8,0]]]
[[[9,7],[1,7]],8]
[[8,[[4,6],[4,8]]],8]
[[[1,9],6],1]
[[[[0,5],[0,0]],7],[4,8]]
[[[[6,0],[4,2]],[8,[5,1]]],[[0,[4,8]],[[3,2],8]]]
[[[[5,9],[5,8]],[9,[0,1]]],[[[8,6],[3,1]],[[9,8],0]]]
[0,[[9,9],[6,2]]]
[[[[7,9],[9,1]],[[1,0],[6,4]]],[4,[[2,1],2]]]
[4,2]
[[[6,5],[[0,6],2]],[[[1,2],0],[[8,9],8]]]
[[8,[[4,1],0]],[[[1,5],[3,5]],3]]
[[[8,3],[[9,1],[8,1]]],[[9,9],3]]
[[2,7],[[[3,9],[2,3]],9]]
[[2,[[7,3],[1,6]]],[[4,4],[2,7]]]
[[[5,6],[3,[5,3]]],[[[2,8],0],[4,[8,8]]]]
[[[1,2],[4,[5,8]]],[8,[8,[9,0]]]]
[[[[0,5],[8,1]],0],[[[5,4],[6,9]],[[7,5],[4,9]]]]
[[9,[2,1]],[[[3,8],[9,5]],[[4,4],4]]]
[[[5,9],[[1,1],[8,9]]],[[1,9],8]]
[[[8,8],[3,9]],[[[2,1],0],9]]
[[[[7,8],2],[5,[3,9]]],[6,1]]
[[[[2,4],[9,1]],[[9,8],[4,4]]],[0,1]]
[[[[8,8],0],9],4]
[[[8,[1,5]],0],[[[8,5],4],[[7,3],[9,5]]]]
[[[5,4],[[5,1],2]],[[[6,8],6],[[3,6],[1,9]]]]
[[[3,[2,5]],[6,[6,2]]],[[0,7],[3,9]]]
[3,[[2,9],8]]
[[[[3,7],[1,6]],[[9,9],[0,3]]],[[[7,3],8],[[3,1],6]]]
[[[[7,1],4],[[4,0],[4,5]]],[8,[[5,3],[4,6]]]]
[[[[0,8],1],[7,9]],[[7,5],[[1,0],[0,9]]]]
[[[9,7],[0,[7,8]]],2]
[[[5,2],5],[0,[[1,6],[2,0]]]]
[[[[3,9],7],7],[[3,[3,4]],[0,[5,9]]]]
[[[[2,5],[9,9]],[1,[6,5]]],6]
[[[1,[5,9]],[[1,1],1]],[5,[[0,4],[9,0]]]]
[[[5,8],[0,7]],[3,[2,[8,6]]]]
[[[[0,7],[7,9]],[[8,4],[8,7]]],[0,[[3,7],9]]]
[[[5,[5,5]],[[9,5],8]],[[[2,1],5],9]]
[5,[4,[[3,6],[3,2]]]]
[[[9,4],3],[[[8,7],[7,5]],[8,[7,7]]]]
[9,[[[9,2],0],[[9,9],[4,3]]]]
[[[4,[7,2]],[[7,9],[5,4]]],1]
[[[[4,9],5],7],[[5,6],0]]
[[[5,[3,1]],[8,1]],[8,[7,0]]]
[[5,6],[6,[[0,5],0]]]
[[[5,[4,5]],9],6]
[[[9,[7,0]],6],[2,[1,6]]]
[[[9,[8,4]],[7,[6,0]]],[[[4,6],[7,5]],[8,[0,8]]]]
[0,7]
[[3,[3,8]],[9,[[3,1],[4,4]]]]
[[6,7],[8,9]]
[[[[9,8],[0,2]],[[4,0],[7,5]]],[[[5,0],1],2]]
[[[[1,2],[3,9]],1],[[5,1],[0,1]]]
[[[[5,8],0],6],[7,0]]
[[[8,[5,4]],[[3,0],7]],[[8,[7,5]],4]]
[[[[5,8],8],8],[[[0,4],[2,5]],0]]
[[[9,6],3],[[[3,3],1],[2,[9,2]]]]
[[[6,3],6],[[[4,1],8],[2,3]]]
[2,[[1,8],0]]
[5,[[[7,6],[1,9]],[4,[8,2]]]]
[[[[6,9],[0,7]],[[2,7],8]],[[6,0],[2,[1,6]]]]
[[[[7,8],[5,1]],[[2,9],2]],0]
[5,3]
[2,[7,[7,[5,8]]]]
[[3,3],[8,[2,6]]]`;

// eslint-disable-next-line no-unused-vars
const test1 = `[[[[4,3],4],4],[7,[[8,4],9]]]
[1,1]`;


// const lines = input.split('\n');
// // const lines = test.split('\n');

// const parsed = lines.map((line) => line.split('').map(Number));


const DIGITS = '1234567890';

// Part 1:
function addSnails(leftSnail, rightSnail) {
    // console.log('leftSnail', leftSnail, 'rightSnail', rightSnail);
    return `[${leftSnail},${rightSnail}]`;
}

// const testAdd = addSnails(parsed[0], parsed[1]);
// console.log(testAdd);

function tooDeep(snail) {
    let depth = 0;
    for (let i = 0; i < snail.length; i++) {
        if (snail[i] === '[') {
            depth++;
        } else if (snail[i] === ']') {
            depth--;
        }
        if (depth > 4) {
            return i;
        }
    }
    return -1;
}

// console.log(tooDeep(testAdd));

// console.log(tooDeep('[[[[[9,8],1],2],3],4]'));

// console.log(tooDeep('[7,[6,[5,[4,[3,2]]]]]'));

function explode(snail, start) {
    const beginning = snail.slice(0, start);
    const rest1 = snail.slice(start);
    const rest2 = rest1.indexOf(']') + 1;
    const explosive = rest1.slice(0, rest2);
    const ending = rest1.slice(rest2);
    const exleft = parseInt(explosive.slice(1, explosive.indexOf(',')), 10);
    const exright = parseInt(explosive.slice(explosive.indexOf(',') + 1, explosive.length - 1), 10);
    // Find left outside value
    let leftstart = -1;
    let leftend = -1;
    for (let i = beginning.length - 1; i >= 0; i--) {
        if (DIGITS.includes(beginning[i]) && leftend === -1) {
            leftend = i;
        }
        if (DIGITS.includes(beginning[i]) && leftstart <= (i + 1)) {
            leftstart = i;
        }
    }
    // console.log('leftstart', leftstart, 'leftend', leftend);
    const left = parseInt(beginning.slice(leftstart, leftend + 1), 10) + exleft;
    // console.log('left', left);
    // Build full left side
    const leftside = left ? `${beginning.slice(0, leftstart)}${left}${beginning.slice(leftend + 1)}` : beginning;
    // Find right outside value
    let rightstart = -1;
    let rightend = Number.MAX_SAFE_INTEGER;
    for (let i = 0; i < ending.length; i++) {
        if (DIGITS.includes(ending[i]) && rightstart === -1) {
            rightstart = i;
        }
        if (DIGITS.includes(ending[i]) && rightend >= (i - 1)) {
            rightend = i;
        }
    }
    // console.log('rightstart', rightstart, 'rightend', rightend);
    const right = parseInt(ending.slice(rightstart, rightend + 1), 10) + exright;
    // console.log('right', right);
    // Build full right side
    const rightside = right ? `${ending.slice(0, rightstart)}${right || ''}${ending.slice(rightend + 1)}` : ending;
    // console.log('leftside', leftside, 'rightside', rightside);

    // console.log('beginning', beginning, 'explosive', explosive, 'exleft', exleft, 'exright', exright, 'ending', ending);

    const full = `${leftside}0${rightside}`;
    // console.log('full', full);
    return full;
}

// console.log(explode('[[[[[9,8],1],2],3],4]', 4));

// console.log(explode('[7,[6,[5,[4,[3,2]]]]]', 12));

// Find all numbers too big in this string
function tooBig(snail) {
    // console.log('Testing', snail);
    let firstIndex = -1;
    for (let i = 0; i < snail.length; i++) {
        // console.log('i', i, snail[i]);
        if (DIGITS.includes(snail[i]) && DIGITS.includes(snail[i + 1])) {
            // Number too big at this location
            firstIndex = i;
            for (let j = i; j < snail.length; j++) {
                if (!(DIGITS.includes(snail[j]))) {
                    return [firstIndex, j];
                }
            }
        }
    }
    return [-1, -1];
}

// const testTooBig = '[[[[0,7],4],[15,[0,13]]],[1,1]]';

// console.log(tooBig(testTooBig));

// const testTooBig2 = '[[[[9,5],[17,9]],[[7,0],[7,17]]],[[[0,4],6],[8,7]]]';

// console.log(tooBig(testTooBig2));

function split(snail, [start, end]) {
    const beginning = snail.slice(0, start);
    const ending = snail.slice(end);
    const num = parseInt(snail.slice(start, end), 10);
    // console.log('beginning', beginning, 'ending', ending, 'num', num);
    const splitleft = Math.floor(num / 2);
    const splitright = Math.ceil(num / 2);
    const insert = `[${splitleft},${splitright}]`;
    return `${beginning}${insert}${ending}`;
}

// console.log(split(testTooBig, [13, 15]));

function processSnails(snail1, snail2) {
    let snails = addSnails(snail1, snail2);
    let modified = false;
    do {
        modified = false;
        const tooDeepIndex = tooDeep(snails);
        if (tooDeepIndex !== -1) {
            modified = true;
            snails = explode(snails, tooDeepIndex);
        }
        if (!modified) {
            const tooBigIndex = tooBig(snails);
            if (tooBigIndex[0] !== -1) {
                modified = true;
                snails = split(snails, tooBigIndex);
            }
        }
    } while (modified);
    return snails;
}

// console.log(processSnails('[[[[4,3],4],4],[7,[[8,4],9]]]', '[1,1]'));

function processAllSnails(list) {
    const toProcess = list.slice();
    while (toProcess.length > 1) {
        const first = toProcess.shift();
        const second = toProcess.shift();
        toProcess.unshift(processSnails(first, second));
    }
    return toProcess[0];
}

// const testlist1 = `[1,1]
// [2,2]
// [3,3]
// [4,4]
// [5,5]
// [6,6]`;

// console.log(processAllSnails(testlist1.split('\n')));

// const testlist2 = `[[[0,[4,5]],[0,0]],[[[4,5],[2,6]],[9,5]]]
// [7,[[[3,7],[4,3]],[[6,3],[8,8]]]]
// [[2,[[0,8],[3,4]]],[[[6,7],1],[7,[1,6]]]]
// [[[[2,4],7],[6,[0,5]]],[[[6,8],[2,8]],[[2,1],[4,5]]]]
// [7,[5,[[3,8],[1,4]]]]
// [[2,[2,2]],[8,[8,1]]]
// [2,9]
// [1,[[[9,3],9],[[9,0],[0,7]]]]
// [[[5,[7,4]],7],1]
// [[[[4,2],2],6],[8,7]]`;

// console.log(processAllSnails(testlist2.split('\n')));

function getValue(array) {
    // console.log('getValue', array);
    let value = 0;
    for (let i = 0; i < 2; i++) {
        if (Array.isArray(array[i])) {
            value += getValue(array[i]) * (3 - i);
        } else {
            value += array[i] * (3 - i);
        }
    }
    // console.log('value', value);
    return value;
}

function magnitude(snail) {
    return getValue(JSON.parse(snail));
}

// console.log(magnitude('[[1,2],[[3,4],5]]')); // 143
// console.log(magnitude('[[[[0,7],4],[[7,8],[6,0]]],[8,1]]')); // 1384
// console.log(magnitude('[[[[1,1],[2,2]],[3,3]],[4,4]]')); // 445
// console.log(magnitude('[[[[3,0],[5,3]],[4,4]],[5,5]]')); // 791
// console.log(magnitude('[[[[5,0],[7,4]],[5,5]],[6,6]]')); // 1137
// console.log(magnitude('[[[[8,7],[7,7]],[[8,6],[7,7]]],[[[0,7],[6,6]],[8,7]]]')); // 3488

function puzzle1() {
    const sum = processAllSnails(input.split('\n'));
    return magnitude(sum);
}

const part1 = puzzle1();
console.log('Part 1:', part1);

// Part 2:
function puzzle2() {
    const snailList = input.split('\n');
    let max = 0;
    for (let i = 0; i < snailList.length; i++) {
        for (let j = 0; j < snailList.length; j++) {
            if (i !== j) {
                const sum = magnitude(processSnails(snailList[i], snailList[j]));
                if (sum > max) {
                    max = sum;
                }
            }
        }
    }
    return max;
}

const part2 = puzzle2();
console.log('Part 2:', part2);
